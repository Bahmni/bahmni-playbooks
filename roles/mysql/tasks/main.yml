---
- name: add mysql 5.7 yum repo
  template:
    src=mysql.repo.j2
    dest=/etc/yum.repos.d/mysql.repo

- name: Install python mysql for ansible
  yum: name=MySQL-python state=present

- name: Check if any version of mysql is present
  command: mysql --version
  register: mysqlVersion
  ignore_errors: true

- name: Uninstall MySQL if 5.7 is absent
  yum: name={{ item }} state=absent
  with_items:
    - mysql-server
    - mysql
  when: mysqlVersion|success and mysqlVersion.stdout.find('5.7') == -1

- name: Install mysql from mysql5.7 yum repository
  yum: name={{ item }} state=present
  with_items:
    - mysql-community-common
    - mysql-community-libs
    - mysql-community-client
    - mysql-community-server

  when: mysqlVersion|failed or mysqlVersion.stdout.find('5.7') == -1

- name: Start Mysql Service
  service: name=mysqld state=started enabled=true

- name: Update mysql root password
  command: /usr/bin/sh /opt/bahmni-installer/bahmni-playbooks/roles/mysql/tasks/mysql_secure_installation.sh
  ignore_errors: yes

- block:

    - name: Get matched IpTable rule
      shell: iptables -nL --line-numbers | grep MYSQL  -m 1 | cut -c 1-2
      register: matchedRule

    - name: delete matching rule if exists
      shell: iptables -D INPUT {{ matchedRule.stdout }}
      when: matchedRule.stdout!=""

    - name: Allow mysql port through firewall
      command: /sbin/iptables -I INPUT 1 -p tcp --dport 3306 -j ACCEPT -m comment --comment "MYSQL"

    - name: save iptables
      command: service iptables save

  when: docker is not defined